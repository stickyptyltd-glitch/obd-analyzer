/**
 * AUTOMOTIVE EXPLOIT DATABASE BROWSER
 *
 * Browse known CVEs and vehicle exploits
 */

import { useState, useEffect } from "react";
import { ExploitDatabase, type VehicleExploit } from "@/lib/exploitDatabase";

export default function ExploitBrowser() {
  const [db] = useState(() => new ExploitDatabase());
  const [exploits, setExploits] = useState<VehicleExploit[]>([]);
  const [selectedExploit, setSelectedExploit] = useState<VehicleExploit | null>(null);

  const [searchManufacturer, setSearchManufacturer] = useState("");
  const [searchModel, setSearchModel] = useState("");
  const [searchYear, setSearchYear] = useState("");
  const [filterSeverity, setFilterSeverity] = useState("");
  const [filterCategory, setFilterCategory] = useState("");
  const [filterPatched, setFilterPatched] = useState("");

  const [stats, setStats] = useState(db.getStatistics());

  useEffect(() => {
    handleSearch();
  }, []);

  const handleSearch = () => {
    const results = db.search({
      manufacturer: searchManufacturer || undefined,
      model: searchModel || undefined,
      year: searchYear ? parseInt(searchYear) : undefined,
      severity: filterSeverity || undefined,
      category: filterCategory || undefined,
      patched: filterPatched ? filterPatched === "true" : undefined
    });

    setExploits(results);
  };

  const clearFilters = () => {
    setSearchManufacturer("");
    setSearchModel("");
    setSearchYear("");
    setFilterSeverity("");
    setFilterCategory("");
    setFilterPatched("");
    setExploits(db.getAll());
  };

  const getSeverityColor = (severity: string) => {
    const colors = {
      critical: "#ff0000",
      high: "#ff6600",
      medium: "#ffaa00",
      low: "#00ff00"
    };
    return colors[severity as keyof typeof colors] || "#666";
  };

  return (
    <div style={{
      padding: '20px',
      backgroundColor: '#0a0a0a',
      color: '#00ff00',
      fontFamily: 'monospace',
      minHeight: '100vh'
    }}>
      <h1 style={{ fontSize: '2.5rem', marginBottom: '20px' }}>
        üîç AUTOMOTIVE EXPLOIT DATABASE
      </h1>

      {/* Statistics */}
      <div style={{
        padding: '20px',
        backgroundColor: '#1a1a1a',
        borderRadius: '8px',
        marginBottom: '20px',
        border: '3px solid #00ff00'
      }}>
        <h2 style={{ fontSize: '1.5rem', marginBottom: '15px' }}>üìä Database Statistics</h2>

        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
          gap: '15px'
        }}>
          <div style={{
            padding: '15px',
            backgroundColor: '#000',
            borderRadius: '6px',
            textAlign: 'center'
          }}>
            <div style={{ fontSize: '2rem', fontWeight: 'bold' }}>{stats.total}</div>
            <div style={{ opacity: 0.7 }}>Total Exploits</div>
          </div>

          <div style={{
            padding: '15px',
            backgroundColor: '#3d0000',
            borderRadius: '6px',
            textAlign: 'center'
          }}>
            <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#ff0000' }}>
              {stats.bySeverity.critical || 0}
            </div>
            <div style={{ opacity: 0.7 }}>Critical</div>
          </div>

          <div style={{
            padding: '15px',
            backgroundColor: '#3d2200',
            borderRadius: '6px',
            textAlign: 'center'
          }}>
            <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#ff6600' }}>
              {stats.bySeverity.high || 0}
            </div>
            <div style={{ opacity: 0.7 }}>High</div>
          </div>

          <div style={{
            padding: '15px',
            backgroundColor: '#003d00',
            borderRadius: '6px',
            textAlign: 'center'
          }}>
            <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#00ff00' }}>
              {stats.patched}
            </div>
            <div style={{ opacity: 0.7 }}>Patched</div>
          </div>

          <div style={{
            padding: '15px',
            backgroundColor: '#3d0000',
            borderRadius: '6px',
            textAlign: 'center'
          }}>
            <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#ff3333' }}>
              {stats.unpatched}
            </div>
            <div style={{ opacity: 0.7 }}>Unpatched</div>
          </div>
        </div>
      </div>

      {/* Search & Filter */}
      <div style={{
        padding: '20px',
        backgroundColor: '#1a1a1a',
        borderRadius: '8px',
        marginBottom: '20px',
        border: '3px solid #0066aa'
      }}>
        <h2 style={{ fontSize: '1.5rem', marginBottom: '15px', color: '#0066aa' }}>
          üîé Search & Filter
        </h2>

        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
          gap: '15px',
          marginBottom: '15px'
        }}>
          <div>
            <label style={{ display: 'block', marginBottom: '5px' }}>Manufacturer:</label>
            <input
              type="text"
              value={searchManufacturer}
              onChange={(e) => setSearchManufacturer(e.target.value)}
              placeholder="e.g., Jeep, Tesla"
              style={{
                padding: '8px',
                backgroundColor: '#000',
                color: '#00ff00',
                border: '2px solid #0066aa',
                borderRadius: '4px',
                fontSize: '1rem',
                width: '100%'
              }}
            />
          </div>

          <div>
            <label style={{ display: 'block', marginBottom: '5px' }}>Model:</label>
            <input
              type="text"
              value={searchModel}
              onChange={(e) => setSearchModel(e.target.value)}
              placeholder="e.g., Cherokee, Model S"
              style={{
                padding: '8px',
                backgroundColor: '#000',
                color: '#00ff00',
                border: '2px solid #0066aa',
                borderRadius: '4px',
                fontSize: '1rem',
                width: '100%'
              }}
            />
          </div>

          <div>
            <label style={{ display: 'block', marginBottom: '5px' }}>Year:</label>
            <input
              type="number"
              value={searchYear}
              onChange={(e) => setSearchYear(e.target.value)}
              placeholder="2020"
              style={{
                padding: '8px',
                backgroundColor: '#000',
                color: '#00ff00',
                border: '2px solid #0066aa',
                borderRadius: '4px',
                fontSize: '1rem',
                width: '100%'
              }}
            />
          </div>

          <div>
            <label style={{ display: 'block', marginBottom: '5px' }}>Severity:</label>
            <select
              value={filterSeverity}
              onChange={(e) => setFilterSeverity(e.target.value)}
              style={{
                padding: '8px',
                backgroundColor: '#000',
                color: '#00ff00',
                border: '2px solid #0066aa',
                borderRadius: '4px',
                fontSize: '1rem',
                width: '100%'
              }}
            >
              <option value="">All</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>

          <div>
            <label style={{ display: 'block', marginBottom: '5px' }}>Category:</label>
            <select
              value={filterCategory}
              onChange={(e) => setFilterCategory(e.target.value)}
              style={{
                padding: '8px',
                backgroundColor: '#000',
                color: '#00ff00',
                border: '2px solid #0066aa',
                borderRadius: '4px',
                fontSize: '1rem',
                width: '100%'
              }}
            >
              <option value="">All</option>
              <option value="remote">Remote</option>
              <option value="physical">Physical</option>
              <option value="wireless">Wireless</option>
              <option value="network">Network</option>
              <option value="crypto">Cryptographic</option>
            </select>
          </div>

          <div>
            <label style={{ display: 'block', marginBottom: '5px' }}>Patch Status:</label>
            <select
              value={filterPatched}
              onChange={(e) => setFilterPatched(e.target.value)}
              style={{
                padding: '8px',
                backgroundColor: '#000',
                color: '#00ff00',
                border: '2px solid #0066aa',
                borderRadius: '4px',
                fontSize: '1rem',
                width: '100%'
              }}
            >
              <option value="">All</option>
              <option value="true">Patched</option>
              <option value="false">Unpatched</option>
            </select>
          </div>
        </div>

        <div style={{ display: 'flex', gap: '10px' }}>
          <button
            onClick={handleSearch}
            style={{
              padding: '10px 20px',
              backgroundColor: '#0066aa',
              color: '#fff',
              border: 'none',
              borderRadius: '6px',
              fontSize: '1rem',
              cursor: 'pointer'
            }}
          >
            üîç Search
          </button>

          <button
            onClick={clearFilters}
            style={{
              padding: '10px 20px',
              backgroundColor: '#666',
              color: '#fff',
              border: 'none',
              borderRadius: '6px',
              fontSize: '1rem',
              cursor: 'pointer'
            }}
          >
            ‚úñÔ∏è Clear Filters
          </button>
        </div>
      </div>

      {/* Results */}
      <div style={{
        padding: '20px',
        backgroundColor: '#1a1a1a',
        borderRadius: '8px',
        marginBottom: '20px',
        border: '3px solid #00ff00'
      }}>
        <h2 style={{ fontSize: '1.5rem', marginBottom: '15px' }}>
          üìã Results ({exploits.length})
        </h2>

        {exploits.length === 0 ? (
          <div style={{ padding: '20px', textAlign: 'center', opacity: 0.5 }}>
            No exploits found matching criteria
          </div>
        ) : (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
            {exploits.map((exploit) => (
              <div
                key={exploit.id}
                onClick={() => setSelectedExploit(exploit)}
                style={{
                  padding: '15px',
                  backgroundColor: selectedExploit?.id === exploit.id ? '#003d00' : '#0a0a0a',
                  border: `2px solid ${getSeverityColor(exploit.severity)}`,
                  borderRadius: '6px',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
              >
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px' }}>
                  <div>
                    <div style={{ fontSize: '1.1rem', fontWeight: 'bold', marginBottom: '5px' }}>
                      {exploit.title}
                    </div>
                    <div style={{ fontSize: '0.9rem', opacity: 0.7 }}>
                      {exploit.manufacturer} | {exploit.models.join(', ')} | {exploit.years[0]}-{exploit.years[exploit.years.length - 1]}
                    </div>
                  </div>
                  <div style={{
                    padding: '5px 10px',
                    backgroundColor: getSeverityColor(exploit.severity),
                    color: '#000',
                    borderRadius: '4px',
                    fontSize: '0.8rem',
                    fontWeight: 'bold'
                  }}>
                    {exploit.severity.toUpperCase()}
                  </div>
                </div>

                <div style={{ fontSize: '0.85rem', opacity: 0.8 }}>
                  {exploit.description.substr(0, 150)}...
                </div>

                <div style={{ marginTop: '8px', display: 'flex', gap: '10px', fontSize: '0.8rem' }}>
                  <span style={{
                    padding: '3px 8px',
                    backgroundColor: '#1a1a1a',
                    borderRadius: '3px'
                  }}>
                    {exploit.category}
                  </span>
                  {exploit.cveId && (
                    <span style={{
                      padding: '3px 8px',
                      backgroundColor: '#1a1a1a',
                      borderRadius: '3px'
                    }}>
                      {exploit.cveId}
                    </span>
                  )}
                  <span style={{
                    padding: '3px 8px',
                    backgroundColor: exploit.patched ? '#003d00' : '#3d0000',
                    borderRadius: '3px'
                  }}>
                    {exploit.patched ? '‚úÖ Patched' : '‚ö†Ô∏è Unpatched'}
                  </span>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Detailed View */}
      {selectedExploit && (
        <div style={{
          padding: '20px',
          backgroundColor: '#1a1a1a',
          borderRadius: '8px',
          border: `3px solid ${getSeverityColor(selectedExploit.severity)}`
        }}>
          <h2 style={{
            fontSize: '1.8rem',
            marginBottom: '20px',
            color: getSeverityColor(selectedExploit.severity)
          }}>
            {selectedExploit.title}
          </h2>

          <div style={{ marginBottom: '20px' }}>
            <div style={{ marginBottom: '10px' }}>
              <strong>CVE ID:</strong> {selectedExploit.cveId || 'N/A'}
            </div>
            <div style={{ marginBottom: '10px' }}>
              <strong>Manufacturer:</strong> {selectedExploit.manufacturer}
            </div>
            <div style={{ marginBottom: '10px' }}>
              <strong>Affected Models:</strong> {selectedExploit.models.join(', ')}
            </div>
            <div style={{ marginBottom: '10px' }}>
              <strong>Affected Years:</strong> {selectedExploit.years.join(', ')}
            </div>
            <div style={{ marginBottom: '10px' }}>
              <strong>Category:</strong> {selectedExploit.category}
            </div>
            <div style={{ marginBottom: '10px' }}>
              <strong>Discovered:</strong> {selectedExploit.discovered}
            </div>
            <div style={{ marginBottom: '10px' }}>
              <strong>Status:</strong> {selectedExploit.patched ? '‚úÖ Patched' : '‚ö†Ô∏è Unpatched'}
            </div>
          </div>

          <div style={{ marginBottom: '20px' }}>
            <h3 style={{ fontSize: '1.3rem', marginBottom: '10px' }}>Description:</h3>
            <p style={{ lineHeight: '1.6' }}>{selectedExploit.description}</p>
          </div>

          <div style={{ marginBottom: '20px' }}>
            <h3 style={{ fontSize: '1.3rem', marginBottom: '10px' }}>Impact:</h3>
            <ul style={{ paddingLeft: '20px', lineHeight: '1.8' }}>
              {selectedExploit.impact.map((item, i) => (
                <li key={i}>{item}</li>
              ))}
            </ul>
          </div>

          {selectedExploit.exploitCode && (
            <div style={{ marginBottom: '20px' }}>
              <h3 style={{ fontSize: '1.3rem', marginBottom: '10px', color: '#ff3333' }}>
                Exploit Code:
              </h3>
              <pre style={{
                padding: '15px',
                backgroundColor: '#000',
                borderRadius: '6px',
                overflowX: 'auto',
                fontSize: '0.85rem',
                border: '2px solid #ff3333'
              }}>
                {selectedExploit.exploitCode}
              </pre>
            </div>
          )}

          {selectedExploit.mitigation && (
            <div style={{ marginBottom: '20px' }}>
              <h3 style={{ fontSize: '1.3rem', marginBottom: '10px', color: '#00ff00' }}>
                Mitigation:
              </h3>
              <p style={{
                padding: '15px',
                backgroundColor: '#003d00',
                borderRadius: '6px',
                border: '2px solid #00ff00'
              }}>
                {selectedExploit.mitigation}
              </p>
            </div>
          )}

          <div>
            <h3 style={{ fontSize: '1.3rem', marginBottom: '10px' }}>References:</h3>
            <ul style={{ paddingLeft: '20px', lineHeight: '1.8' }}>
              {selectedExploit.references.map((ref, i) => (
                <li key={i} style={{ wordBreak: 'break-word' }}>{ref}</li>
              ))}
            </ul>
          </div>
        </div>
      )}
    </div>
  );
}
