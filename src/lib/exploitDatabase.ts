/**
 * AUTOMOTIVE EXPLOIT DATABASE
 *
 * Known CVEs, exploits, and vulnerabilities for vehicle systems
 */

export interface VehicleExploit {
  id: string;
  cveId?: string;
  title: string;
  manufacturer: string;
  models: string[];
  years: number[];
  severity: "critical" | "high" | "medium" | "low";
  category: "remote" | "physical" | "wireless" | "network" | "crypto";
  description: string;
  impact: string[];
  exploitCode?: string;
  mitigation?: string;
  references: string[];
  discovered: string;
  patched: boolean;
}

export interface ExploitSearchQuery {
  manufacturer?: string;
  model?: string;
  year?: number;
  severity?: string;
  category?: string;
  patched?: boolean;
}

export class ExploitDatabase {
  private exploits: VehicleExploit[] = [];

  constructor() {
    this.loadExploits();
  }

  private loadExploits(): void {
    this.exploits = [
      // Jeep Cherokee Remote Hack (2015)
      {
        id: "EXP-2015-001",
        cveId: "CVE-2015-5611",
        title: "Jeep Cherokee Uconnect Remote Code Execution",
        manufacturer: "Jeep/Chrysler",
        models: ["Cherokee", "Grand Cherokee", "Wrangler"],
        years: [2014, 2015, 2016],
        severity: "critical",
        category: "remote",
        description: "Remote exploitation of Uconnect infotainment system via cellular network. Allows complete vehicle control including steering, brakes, and transmission.",
        impact: [
          "Remote control of steering",
          "Remote brake activation",
          "Transmission manipulation",
          "Engine kill",
          "Door lock/unlock"
        ],
        exploitCode: `
// Connect to Sprint cellular network bridge
// CAN message injection via Uconnect D-Bus
send_can_frame(0x292, [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]); // Disable ABS
send_can_frame(0x2C1, [0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]); // Unlock doors
        `.trim(),
        mitigation: "Update Uconnect firmware to 15.26.1 or later",
        references: [
          "Miller & Valasek - Remote Exploitation of an Unaltered Passenger Vehicle",
          "https://www.wired.com/2015/07/hackers-remotely-kill-jeep-highway/"
        ],
        discovered: "2015-07-21",
        patched: true
      },

      // Tesla Model S Key Fob Relay (2018)
      {
        id: "EXP-2018-002",
        cveId: "CVE-2018-16806",
        title: "Tesla Model S/X Key Fob Relay Attack",
        manufacturer: "Tesla",
        models: ["Model S", "Model X"],
        years: [2016, 2017, 2018],
        severity: "high",
        category: "wireless",
        description: "BLE relay attack allows theft of Tesla vehicles by extending key fob range. No encryption on BLE pairing.",
        impact: [
          "Vehicle theft without physical key",
          "Door unlock from extended range",
          "Start vehicle remotely"
        ],
        exploitCode: `
// BLE relay using two HackRF devices
hackrf_transfer -t ble_relay.raw -f 2402000000 -s 2000000 -x 40
// Relay between victim's key fob and vehicle
        `.trim(),
        mitigation: "Enable PIN to Drive feature, update to firmware 2018.24 or later",
        references: [
          "KU Leuven - Tesla Key Fob Relay Attack",
          "https://www.wired.com/story/tesla-model-s-x-hack-bluetooth/"
        ],
        discovered: "2018-09-04",
        patched: true
      },

      // VW/Audi MQB IMMO Bypass (2019)
      {
        id: "EXP-2019-003",
        cveId: "CVE-2019-9647",
        title: "VW Group MQB Platform IMMO4/5 Cryptographic Weakness",
        manufacturer: "Volkswagen/Audi",
        models: ["Golf VII", "Passat B8", "Audi A3 8V", "Tiguan", "Polo AW"],
        years: [2016, 2017, 2018, 2019, 2020],
        severity: "critical",
        category: "crypto",
        description: "Weak cryptographic implementation in MQB IMMO system allows key derivation from Component Security (CS) data. Enables All Keys Lost programming without dealer codes.",
        impact: [
          "Clone keys without original",
          "All Keys Lost programming",
          "Bypass IMMO protection",
          "Vehicle theft"
        ],
        exploitCode: `
// Extract CS data from BCM via OBD
cs_data = read_eeprom(0x19, 0x00, 16);
// Derive dealer key using weak algorithm
dealer_key = sha256(cs_data + vin);
// Program new key
write_immo_key(dealer_key, new_transponder_id);
        `.trim(),
        mitigation: "No official patch available. Physical security measures recommended.",
        references: [
          "Garcia, Oswald, Kasper, Pavlides - Lock It and Still Lose It",
          "https://eprint.iacr.org/2019/1141"
        ],
        discovered: "2019-10-01",
        patched: false
      },

      // BMW NBT EVO Remote Services Exploit (2020)
      {
        id: "EXP-2020-004",
        cveId: "CVE-2020-11493",
        title: "BMW ConnectedDrive Remote Services Authentication Bypass",
        manufacturer: "BMW",
        models: ["3-Series", "5-Series", "7-Series", "X5", "X6"],
        years: [2018, 2019, 2020],
        severity: "high",
        category: "remote",
        description: "Authentication bypass in BMW ConnectedDrive allows unauthorized remote door unlock and vehicle location tracking.",
        impact: [
          "Remote door unlock",
          "Vehicle location tracking",
          "Climate control manipulation",
          "Vehicle status monitoring"
        ],
        mitigation: "Update ConnectedDrive firmware, revoke and reissue API tokens",
        references: [
          "ACSAC 2020 - BMW ConnectedDrive Security Analysis"
        ],
        discovered: "2020-03-15",
        patched: true
      },

      // GM OnStar RemoteLink Command Injection (2015)
      {
        id: "EXP-2015-005",
        cveId: "CVE-2015-7646",
        title: "GM OnStar RemoteLink Mobile App Command Injection",
        manufacturer: "General Motors",
        models: ["Corvette", "Volt", "Camaro", "Silverado", "Tahoe"],
        years: [2013, 2014, 2015],
        severity: "high",
        category: "remote",
        description: "Credential harvesting via RemoteLink app allows unauthorized remote start, unlock, and location tracking.",
        impact: [
          "Remote vehicle unlock",
          "Remote engine start",
          "GPS tracking",
          "Horn/lights activation"
        ],
        mitigation: "Update RemoteLink app to version 2.2.0, change OnStar password",
        references: [
          "Samy Kamkar - OwnStar Presentation",
          "https://www.defcon.org/html/defcon-23/dc-23-speakers.html"
        ],
        discovered: "2015-07-30",
        patched: true
      },

      // Ford SYNC 3 AppLink Code Execution (2017)
      {
        id: "EXP-2017-006",
        title: "Ford SYNC 3 AppLink Arbitrary Code Execution",
        manufacturer: "Ford",
        models: ["F-150", "Escape", "Explorer", "Mustang", "Focus"],
        years: [2016, 2017, 2018],
        severity: "medium",
        category: "physical",
        description: "USB-based exploit allows arbitrary code execution on SYNC 3 infotainment system via malformed AppLink message.",
        impact: [
          "Infotainment system control",
          "CAN bus message injection",
          "Persistent backdoor installation"
        ],
        exploitCode: `
// Malformed AppLink JSON payload
{"app_name": "Exploit", "cmd": "'; rm -rf / #"}
// Triggers command injection in SYNC shell
        `.trim(),
        mitigation: "Update SYNC 3 to version 3.0 or later",
        references: [
          "NCC Group - Ford SYNC Security Assessment"
        ],
        discovered: "2017-06-12",
        patched: true
      },

      // Nissan LEAF Telematics API Exposure (2016)
      {
        id: "EXP-2016-007",
        title: "Nissan LEAF NissanConnect API Lacks Authentication",
        manufacturer: "Nissan",
        models: ["LEAF"],
        years: [2014, 2015, 2016],
        severity: "medium",
        category: "remote",
        description: "NissanConnect API allows anyone to control climate and access battery status using only the VIN (visible through windshield).",
        impact: [
          "Climate control access",
          "Battery drain attack",
          "Location tracking",
          "Driving history access"
        ],
        mitigation: "Nissan disabled vulnerable API endpoints. Update to NissanConnect EV 2.0",
        references: [
          "Troy Hunt - Controlling Nissan LEAFs",
          "https://www.troyhunt.com/controlling-vehicle-features-of-nissan/"
        ],
        discovered: "2016-02-23",
        patched: true
      },

      // Mercedes-Benz E-Class Gateway Bypass (2021)
      {
        id: "EXP-2021-008",
        title: "Mercedes-Benz Central Gateway Authentication Bypass",
        manufacturer: "Mercedes-Benz",
        models: ["E-Class W213", "S-Class W222", "GLE"],
        years: [2019, 2020, 2021],
        severity: "critical",
        category: "network",
        description: "Authentication bypass in Central Gateway allows direct access to protected ECUs and CAN networks from OBD port.",
        impact: [
          "Access to all vehicle ECUs",
          "Flash ECU firmware",
          "Disable security systems",
          "Clone keys",
          "Odometer manipulation"
        ],
        exploitCode: `
// Send gateway unlock sequence
send_uds(0x7E0, [0x27, 0x01]); // Request seed
seed = receive_uds()[2:6];
key = calculate_mb_key(seed); // Weak key derivation
send_uds(0x7E0, [0x27, 0x02] + key); // Send key
// Gateway now unlocked
        `.trim(),
        mitigation: "No official patch. Requires hardware gateway replacement.",
        references: [
          "MB KeyPRO - Central Gateway Exploit Documentation"
        ],
        discovered: "2021-05-10",
        patched: false
      },

      // Honda Civic Immobilizer Bypass (2020)
      {
        id: "EXP-2020-009",
        title: "Honda Civic EEPROM Key Extraction",
        manufacturer: "Honda",
        models: ["Civic", "Accord", "CR-V"],
        years: [2016, 2017, 2018, 2019, 2020],
        severity: "high",
        category: "physical",
        description: "EEPROM dump from ECU contains plaintext transponder keys. No encryption on key storage.",
        impact: [
          "Extract all programmed keys",
          "Clone transponders",
          "Vehicle theft",
          "Program new keys"
        ],
        exploitCode: `
// Read ECU EEPROM via OBD
eeprom = read_memory_uds(0x0000, 0x2000);
// Keys stored at fixed offset
key1 = eeprom[0x0800:0x0810];
key2 = eeprom[0x0810:0x0820];
// No encryption, direct transponder cloning possible
        `.trim(),
        mitigation: "No patch available. Encrypted key storage needed.",
        references: [
          "Honda Immobilizer Research - HondaKeyPro"
        ],
        discovered: "2020-08-22",
        patched: false
      },

      // Hyundai/Kia TikTok Challenge Vulnerability (2022)
      {
        id: "EXP-2022-010",
        title: "Hyundai/Kia Theft via Steering Column Bypass",
        manufacturer: "Hyundai/Kia",
        models: ["Elantra", "Sonata", "Tucson", "Sportage", "Soul"],
        years: [2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022],
        severity: "critical",
        category: "physical",
        description: "Vehicles lack engine immobilizer. Steering column can be removed with screwdriver, allowing ignition bypass with USB cable.",
        impact: [
          "Complete vehicle theft in <60 seconds",
          "No alarm activation",
          "Works on millions of vehicles"
        ],
        exploitCode: `
// Physical exploit:
// 1. Break window or use slim jim
// 2. Remove steering column cover
// 3. Insert USB-A cable into ignition slot
// 4. Turn to start engine
// No transponder or IMMO present
        `.trim(),
        mitigation: "Install aftermarket immobilizer. Kia offers free steering wheel lock.",
        references: [
          "Highway Loss Data Institute - Kia/Hyundai Theft Rates",
          "Multiple police department alerts"
        ],
        discovered: "2022-07-01",
        patched: false
      }
    ];
  }

  search(query: ExploitSearchQuery): VehicleExploit[] {
    return this.exploits.filter(exploit => {
      if (query.manufacturer && !exploit.manufacturer.toLowerCase().includes(query.manufacturer.toLowerCase())) {
        return false;
      }

      if (query.model && !exploit.models.some(m => m.toLowerCase().includes(query.model!.toLowerCase()))) {
        return false;
      }

      if (query.year && !exploit.years.includes(query.year)) {
        return false;
      }

      if (query.severity && exploit.severity !== query.severity) {
        return false;
      }

      if (query.category && exploit.category !== query.category) {
        return false;
      }

      if (query.patched !== undefined && exploit.patched !== query.patched) {
        return false;
      }

      return true;
    });
  }

  getById(id: string): VehicleExploit | undefined {
    return this.exploits.find(e => e.id === id || e.cveId === id);
  }

  getAll(): VehicleExploit[] {
    return this.exploits;
  }

  getStatistics(): {
    total: number;
    bySeverity: Record<string, number>;
    byCategory: Record<string, number>;
    patched: number;
    unpatched: number;
  } {
    const bySeverity: Record<string, number> = {};
    const byCategory: Record<string, number> = {};
    let patched = 0;

    this.exploits.forEach(exploit => {
      bySeverity[exploit.severity] = (bySeverity[exploit.severity] || 0) + 1;
      byCategory[exploit.category] = (byCategory[exploit.category] || 0) + 1;
      if (exploit.patched) patched++;
    });

    return {
      total: this.exploits.length,
      bySeverity,
      byCategory,
      patched,
      unpatched: this.exploits.length - patched
    };
  }

  getManufacturers(): string[] {
    return [...new Set(this.exploits.map(e => e.manufacturer))].sort();
  }

  addExploit(exploit: VehicleExploit): void {
    this.exploits.push(exploit);
  }

  exportToJSON(): string {
    return JSON.stringify(this.exploits, null, 2);
  }
}
